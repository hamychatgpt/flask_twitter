{% extends "base.html" %}

{% block title %}Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆÛŒÛŒØªâ€ŒÙ‡Ø§{% endblock %}

{% block content %}
<div class="admin-tweets-container">
    <h1>Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆÛŒÛŒØªâ€ŒÙ‡Ø§</h1>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-container">
                {% for category, message in messages %}
                    <div class="flash {{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    
<!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ -->
<div class="admin-section search-filters">
    <h2>Ø¬Ø³ØªØ¬Ùˆ Ùˆ ÙÛŒÙ„ØªØ±</h2>
    <form method="GET" action="{{ url_for('manage_tweets.index') }}" class="filter-form">
        <div class="form-row">
            <div class="form-group">
                <label for="keyword">Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡:</label>
                <input type="text" id="keyword" name="keyword" class="form-control" value="{{ keyword or '' }}">
            </div>
            <div class="form-group">
                <label for="username">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ:</label>
                <input type="text" id="username" name="username" class="form-control" value="{{ username or '' }}">
            </div>
            <div class="form-group">
                <label for="date_from">Ø§Ø² ØªØ§Ø±ÛŒØ®:</label>
                <input type="date" id="date_from" name="date_from" class="form-control" value="{{ date_from or '' }}">
            </div>
            <div class="form-group">
                <label for="date_to">ØªØ§ ØªØ§Ø±ÛŒØ®:</label>
                <input type="date" id="date_to" name="date_to" class="form-control" value="{{ date_to or '' }}">
            </div>
            <div class="form-group button-group">
                <button type="submit" class="btn">Ø¬Ø³ØªØ¬Ùˆ</button>
                <a href="{{ url_for('manage_tweets.index') }}" class="btn btn-secondary">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„ØªØ±Ù‡Ø§</a>
            </div>
        </div>
    </form>
</div>

<!-- Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ Ùˆ ÙˆØ¶Ø¹ÛŒØª -->
<div id="search-results" class="search-results" {% if tweets|length == 0 and filter_applied %}style="display:block;"{% elif tweets|length == 0 %}style="display:none;"{% else %}style="display:block;"{% endif %}>
    <div class="alert {% if tweets|length > 0 %}alert-info{% else %}alert-warning{% endif %}">
        {% if tweets|length > 0 %}
            <span id="result-count">{{ tweets|length }}</span> ØªÙˆÛŒÛŒØª ÛŒØ§ÙØª Ø´Ø¯.
        {% else %}
            <span>Ù‡ÛŒÚ† ØªÙˆÛŒÛŒØªÛŒ Ø¨Ø§ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ ÙØ¹Ù„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</span>
        {% endif %}
    </div>
</div>
    

    <!-- Ø¬Ø¯ÙˆÙ„ ØªÙˆÛŒÛŒØªâ€ŒÙ‡Ø§ -->
    <div class="admin-section">
        <h2>Ù„ÛŒØ³Øª ØªÙˆÛŒÛŒØªâ€ŒÙ‡Ø§</h2>
        <div class="table-responsive">
            <table class="tweets-table">
                <thead>
                    <tr>
                        <th>Ø´Ù†Ø§Ø³Ù‡</th>
                        <th>Ù…ØªÙ† ØªÙˆÛŒÛŒØª</th>
                        <th>Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡</th>
                        <th>ØªØ§Ø±ÛŒØ®</th>
                        <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    {% if tweets %}
                        {% for tweet in tweets %}
                            <tr>
                                <td>{{ tweet.id }}</td>
                                <td class="tweet-text">{{ tweet.text }}</td>
                                <td>{{ tweet.username }}</td>
                                <td>{{ tweet.created.strftime('%Y-%m-%d %H:%M') if tweet.created else '' }}</td>
                                <td class="tweet-actions">
                                    <button class="btn-icon view-tweet" data-tweet-id="{{ tweet.id }}" title="Ù…Ø´Ø§Ù‡Ø¯Ù‡">
                                        <span class="icon">ğŸ‘ï¸</span>
                                    </button>
                                    <button class="btn-icon delete-tweet" data-tweet-id="{{ tweet.id }}" title="Ø­Ø°Ù">
                                        <span class="icon">ğŸ—‘ï¸</span>
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5" class="text-center">Ù‡ÛŒÚ† ØªÙˆÛŒÛŒØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    
<!-- ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ -->
{% if total_pages > 1 %}
<div class="pagination">
    {% if page > 1 %}
        <a href="{{ url_for('manage_tweets.index', page=page-1, 
            keyword=keyword if keyword else None, 
            username=username if username else None, 
            date_from=date_from if date_from else None, 
            date_to=date_to if date_to else None) }}" class="pagination-item">Ù‚Ø¨Ù„ÛŒ</a>
    {% endif %}
    
    {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
            <span class="pagination-item active">{{ p }}</span>
        {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
            <a href="{{ url_for('manage_tweets.index', page=p, 
                keyword=keyword if keyword else None, 
                username=username if username else None, 
                date_from=date_from if date_from else None, 
                date_to=date_to if date_to else None) }}" class="pagination-item">{{ p }}</a>
        {% elif p == page - 3 or p == page + 3 %}
            <span class="pagination-item dots">...</span>
        {% endif %}
    {% endfor %}
    
    {% if page < total_pages %}
        <a href="{{ url_for('manage_tweets.index', page=page+1, 
            keyword=keyword if keyword else None, 
            username=username if username else None, 
            date_from=date_from if date_from else None, 
            date_to=date_to if date_to else None) }}" class="pagination-item">Ø¨Ø¹Ø¯ÛŒ</a>
    {% endif %}
</div>
{% endif %}

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÙˆÛŒÛŒØª -->
    <div id="tweet-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÙˆÛŒÛŒØª</h2>
            <div class="tweet-details">
                <div id="tweet-modal-content">
                    <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØªÙˆÛŒÛŒØª Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯ -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒÙ… jQuery Ù„ÙˆØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        console.log("Tweets management script loaded");
        
        // ØªØ¹ÛŒÛŒÙ† ØªØ¹Ø¯Ø§Ø¯ Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ
        var tweetsCount = {{ tweets|length }};
        if (tweetsCount > 0) {
            $('#result-count').text(tweetsCount);
            $('#search-results').show();
        }
        
        // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÙˆÛŒÛŒØª
        $('.view-tweet').on('click', function() {
            const tweetId = $(this).data('tweet-id');
            
            // Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ
            $('#tweet-modal-content').html('<div class="loading">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>');
            $('#tweet-modal').css('display', 'block');
            
            // Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª AJAX Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª ØªÙˆÛŒÛŒØª
            $.ajax({
                url: "{{ url_for('manage_tweets.view_tweet', tweet_id=0) }}".replace('0', tweetId),
                type: 'GET',
                success: function(response) {
                    console.log("Tweet data:", response);
                    
                    // Ø³Ø§Ø®Øª HTML Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª ØªÙˆÛŒÛŒØª
                    var html = `
                        <div class="tweet-detail">
                            <p><strong>Ø´Ù†Ø§Ø³Ù‡:</strong> ${response.id}</p>
                            <p><strong>Ø´Ù†Ø§Ø³Ù‡ ØªÙˆÛŒÛŒØªØ±:</strong> ${response.twitter_id}</p>
                            <p><strong>Ú©Ø§Ø±Ø¨Ø±:</strong> @${response.username}</p>
                            <p><strong>ØªØ§Ø±ÛŒØ®:</strong> ${response.created_at}</p>
                            <p><strong>Ø²Ø¨Ø§Ù†:</strong> ${response.language || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</p>
                            <p><strong>ØªØ¹Ø¯Ø§Ø¯ Ù„Ø§ÛŒÚ©:</strong> ${response.likes_count}</p>
                            <p><strong>ØªØ¹Ø¯Ø§Ø¯ Ø±ÛŒØªÙˆÛŒÛŒØª:</strong> ${response.retweets_count}</p>
                            <p><strong>ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø§Ø³Ø®:</strong> ${response.replies_count}</p>
                            <hr>
                            <p><strong>Ù…ØªÙ† ØªÙˆÛŒÛŒØª:</strong></p>
                            <p class="tweet-full-text">${response.text}</p>
                        </div>
                    `;
                    
                    $('#tweet-modal-content').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Error:", xhr, status, error);
                    $('#tweet-modal-content').html('<div class="error">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙˆÛŒÛŒØª</div>');
                }
            });
        });
        
        // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø­Ø°Ù ØªÙˆÛŒÛŒØª
        $('.delete-tweet').on('click', function() {
            const tweetId = $(this).data('tweet-id');
            const tweetRow = $(this).closest('tr');
            
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ØªÙˆÛŒÛŒØª Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                $.ajax({
                    url: "{{ url_for('manage_tweets.delete_tweet', tweet_id=0) }}".replace('0', tweetId),
                    type: 'POST',
                    contentType: 'application/json',
                    success: function(response) {
                        console.log("Delete response:", response);
                        
                        if (response.status === 'success') {
                            // Ø­Ø°Ù Ø³Ø·Ø± Ø§Ø² Ø¬Ø¯ÙˆÙ„
                            tweetRow.remove();
                            
                            // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
                            alert(response.message);
                            
                            // Ú©Ø§Ù‡Ø´ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ù†ØªØ§ÛŒØ¬
                            tweetsCount--;
                            $('#result-count').text(tweetsCount);
                            
                            // Ø§Ú¯Ø± Ù‡Ù…Ù‡ Ù†ØªØ§ÛŒØ¬ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯
                            if (tweetsCount === 0) {
                                location.reload();
                            }
                        } else {
                            alert(response.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ØªÙˆÛŒÛŒØª');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("Error:", xhr, status, error);
                        alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ØªÙˆÛŒÛŒØª');
                    }
                });
            }
        });
        
        // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„
        $('.close').on('click', function() {
            $('#tweet-modal').css('display', 'none');
        });
        
        // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø®Ø§Ø±Ø¬ Ø§Ø² Ø¢Ù†
        $(window).on('click', function(event) {
            if ($(event.target).is('#tweet-modal')) {
                $('#tweet-modal').css('display', 'none');
            }
        });
    });
</script>
{% endblock %}